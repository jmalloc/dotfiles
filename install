#!/usr/bin/env bash

set -e
set -o pipefail

[ "$DOTFILES_PATH" ] || export DOTFILES_PATH="$(cd $(dirname "$0"); pwd)"

# Install Homebrew.
type -t brew > /dev/null || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# Install 'op' (1Password CLI) and jq to parse results.
type -t op > /dev/null || brew cask install 1password-cli
type -t jq > /dev/null || brew install jq

OP_ACCOUNT="$(echo 'dGVhbS1hd2t3YXJkCg==' | base64 --decode)"
OP_EMAIL="$(echo 'amFtZXMuaGFycmlzQGljZWNhdmUuY29tLmF1Cg==' | base64 --decode)"
OP_SESSION_VAR="OP_SESSION_${OP_ACCOUNT}"

# If there is no existing 1Password session, prompt for details to signin.
if [ -z "${!OP_SESSION_VAR}" ]; then
    eval $(op signin "$OP_ACCOUNT" "$OP_EMAIL")
fi

### END OF INTERACTIVE USAGE ###################################################

for FILE in "$DOTFILES_PATH/install.d/"*.bash; do
    echo ">>> sourcing $FILE"
    source "$FILE"
done
