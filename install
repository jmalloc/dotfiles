#!/usr/bin/env bash

set -e
set -o pipefail

[ "$DOTFILES_PATH" ] || export DOTFILES_PATH="$(cd $(dirname "$0"); pwd)"

# Install Homebrew.
type -t brew > /dev/null || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# Install 'mas' (Mac App Store CLI).
type -t mas > /dev/null || brew install mas

# Install 'op' (1Password CLI) and jq to parse results.
type -t op > /dev/null || brew cask install 1password-cli
type -t jq > /dev/null || brew install jq

if ! mas account > /dev/null; then
    # while [ -z "$MAS_EMAIL" ]; do
    #     echo -n "App Store email address: "
    #     read MAS_EMAIL
    # done

    mas signin --dialog "$MAS_EMAIL"
fi

# If there is no existing 1Password session, prompt for details to signin.
if [ -z "$OP_SESSION_my" ]; then
    while [ -z "$OP_EMAIL" ]; do
        echo -n "1Password email address: "
        read OP_EMAIL
    done

    while [ -z "$OP_KEY" ]; do
        echo -n "1Password secret key (not your master password): "
        read OP_KEY
    done

    eval $(op signin my "$OP_EMAIL" "$OP_KEY")
fi

if [ ! -e "$HOME/.ssh/id_rsa" ]; then
    echo "--- fetching SSH key from 1Password"
    mkdir -p "$HOME/.ssh"
    op get document "SSH Private Key" > "$HOME/.ssh/id_rsa"
    chmod 600 "$HOME/.ssh/id_rsa"
fi

if [ ! -e "$HOME/.ssh/id_rsa.pub" ]; then
    echo "--- generating public key from private key"
    ssh-keygen -yf "$HOME/.ssh/id_rsa" > "$HOME/.ssh/id_rsa.pub"
fi

### END OF INTERACTIVE USAGE ###################################################

for FILE in "$DOTFILES_PATH/install.d/"*.bash; do
    echo ">>> sourcing $FILE"
    source "$FILE"
done
