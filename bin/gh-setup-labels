#!/usr/bin/env php
<?php
error_reporting(-1);

if ($_SERVER['argc'] != 3) {
    echo 'Usage: ' . basename($_SERVER['argv'][0]) . ' <organisation> <token>' . PHP_EOL;
    exit(1);
}

$owner = $_SERVER['argv'][1];
$token = $_SERVER['argv'][2];

// The desired labels and their colours ...
$expected = [
    'semver:major' => 'fff0f0',
    'semver:minor' => 'fff8f0',
    'semver:patch' => 'f0f8ff',
    'feature' => '84b6eb',
    'defect'  => 'fc2929',
    'maintenance' => 'ededed',
    'easy pick' => 'd7e102',
    'documentation' => '006b75',
    'performance' => '5319e7',
    'question' => 'bfdadc',
];

// Labels that should be renamed to match above (instead of deleting and creating a new one) ...
$rename = [
    'bug' => 'defect',
    'enhancement' => 'feature',
    'bc break' => 'semver:major'
];

// ---------------------------------------------------------------------------------------------------------------------

function api($uri, $method = 'GET', $body = null)
{
    global $token;

    $url = 'https://api.github.com/' . ltrim($uri, '/');
    $ch = curl_init($url);

    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
    curl_setopt($ch, CURLOPT_USERAGENT, 'PHP');
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization: token ' . $token]);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    if ($body) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($body));
    }

    $response = curl_exec($ch);

    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    if (!in_array($code, [200, 201, 204])) {
        throw new Exception($code . ': ' . $response);
    }

    return json_decode($response);
}

function create($owner, $repo, $name, $color)
{
    echo ' * create ' . $name . ' with color ' . $color . PHP_EOL;
    api('/repos/' . urlencode($owner) . '/' . urlencode($repo) . '/labels', 'POST', ['name' => $name, 'color' => $color]);
}

function update($owner, $repo, $name, $color = null, $newName = null)
{
    if ($color !== null && $newName !== null) {
        echo ' * rename ' . $name . ' to ' . $newName . ' and set color to ' . $color . PHP_EOL;
        api('/repos/' . urlencode($owner) . '/' . urlencode($repo) . '/labels/' . urlencode($name), 'PATCH', ['name' => $newName, 'color' => $color]);
    } elseif ($color !== null) {
        echo ' * set ' . $name . ' color to ' . $color . PHP_EOL;
        api('/repos/' . urlencode($owner) . '/' . urlencode($repo) . '/labels/' . urlencode($name), 'PATCH', ['color' => $color]);
    } elseif ($newName !== null) {
        echo ' * rename ' . $name . ' to ' . $newName . PHP_EOL;
        api('/repos/' . urlencode($owner) . '/' . urlencode($repo) . '/labels/' . urlencode($name), 'PATCH', ['name' => $newName]);
    }
}

function delete($owner, $repo, $name)
{
    echo ' * delete ' . $name . PHP_EOL;
    api('/repos/' . urlencode($owner) . '/' . urlencode($repo) . '/labels/' . urlencode($name), 'DELETE');
}

$repos = api('/orgs/' . urlencode($owner) . '/repos');


foreach ($repos as $repo) {
    echo $owner . '/' . $repo->name . PHP_EOL;

    $labels = api('/repos/' . urlencode($repo->owner->login) . '/' . urlencode($repo->name) . '/labels');
    $solved = [];

    foreach ($labels as $label) {
        if (array_key_exists($label->name, $expected)) {
            $solved[$label->name] = true;
            $color = $expected[$label->name];
            if ($color !== $label->color) {
                update($owner, $repo->name, $label->name, $color);
            }
        } elseif (array_key_exists($label->name, $rename)) {
            $solved[$rename[$label->name]] = true;
            $color = $expected[$rename[$label->name]];
            if ($color !== $label->color) {
                update($owner, $repo->name, $label->name, $color, $rename[$label->name]);
            } else {
                update($owner, $repo->name, $label->name, null, $rename[$label->name]);
            }
        } else {
            delete($owner, $repo->name, $label->name);
        }
    }

    foreach ($expected as $name => $color) {
        if (!array_key_exists($name, $solved)) {
            create($owner, $repo->name, $name, $color);
        }
    }

    echo PHP_EOL;
}
