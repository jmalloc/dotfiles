#!/usr/bin/env bash

if [ ! -t 1 ]; then
    function tput() {
        return
    }
fi

if [[ "$1" == '--help' ]]; then
    echo "usage: $(basename $0) [<count>]"
    echo
    echo "    <count> (optional, default = 1)"
    echo "        Limit results to <count> tags."
    exit
fi

N="${1:-1}"
echo "$(tput bold)# Changelog$(tput sgr0)"

CURRENT_TAG=
while read HASH; do
    TAG=$(git describe --exact-match $HASH 2>/dev/null)
    if [ ! -z "$TAG" ]; then
        [ $N -gt 0 ] || exit
        ((N--))
        CURRENT_TAG="$TAG"
        echo
        echo "$(tput bold)## $TAG ($(git log $TAG -1 --pretty='%ad' --date=short))$(tput sgr0)"
        echo
    fi

    BODY="$(git log -1 $HASH --pretty='%b' | egrep -v '^\s+$')"

    if [ ! -z "$BODY" ]; then
        if [ -z "$CURRENT_TAG" ]; then
            [ $N -gt 0 ] || exit
            ((N--))
            CURRENT_TAG=next
            echo
            echo "$(tput bold)## Next Release$(tput sgr0)"
            echo
        fi

        if [[ "$CURRENT_TAG" == "next" ]]; then
            echo "$(tput setaf 9)$BODY$(tput sgr0)"
        else
            echo "$BODY"
        fi

    fi
done < <(git log --first-parent --merges -$((N * 10)) --pretty='%H')
